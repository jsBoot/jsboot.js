/*
 <a href="http://www.gnu.org/licenses/agpl-3.0.html">AGPL</a>.
 @copyright All rights reserved <a href="http://www.webitup.fr">copyright WebItUp</a>
 @name https://github.com/jsBoot/jsboot.js/blob/master/src/jsboot/core/errorHandler.js#74-70c39446998be95596b03bc170b23bba337ce8b4
 <a href="http://www.gnu.org/licenses/agpl-3.0.html">AGPL</a>.
 @copyright All rights reserved <a href="http://www.webitup.fr">copyright WebItUp</a>
 @name https://github.com/jsBoot/jsboot.js/blob/master/src/jsboot/core/error.js#74-70c39446998be95596b03bc170b23bba337ce8b4
 @see  http://perfectionkills.com/instanceof-considered-harmful-or-how-to-write-a-robust-isarray/
 @see  http://stackoverflow.com/questions/332422/how-do-i-get-the-name-of-an-objects-type-in-javascript
 <a href="http://www.gnu.org/licenses/agpl-3.0.html">AGPL</a>.
 @copyright All rights reserved <a href="http://www.webitup.fr">copyright WebItUp</a>
 @name https://github.com/jsBoot/jsboot.js/blob/master/src/jsboot/core/errorHandler.js#74-70c39446998be95596b03bc170b23bba337ce8b4
 <a href="http://www.gnu.org/licenses/agpl-3.0.html">AGPL</a>.
 @copyright All rights reserved <a href="http://www.webitup.fr">copyright WebItUp</a>
 @name https://github.com/jsBoot/jsboot.js/blob/master/src/jsboot/controllers/idle.js#74-70c39446998be95596b03bc170b23bba337ce8b4
 <a href="http://www.gnu.org/licenses/agpl-3.0.html">AGPL</a>.
 @copyright All rights reserved <a href="http://www.webitup.fr">copyright WebItUp</a>
 @name https://github.com/jsBoot/jsboot.js/blob/master/src/jsboot/controllers/singleapp.js#74-70c39446998be95596b03bc170b23bba337ce8b4
 <a href="http://www.gnu.org/licenses/agpl-3.0.html">AGPL</a>.
 @copyright All rights reserved <a href="http://www.webitup.fr">copyright WebItUp</a>
 @name https://github.com/jsBoot/jsboot.js/blob/master/src/jsboot/utils/storage.js#74-70c39446998be95596b03bc170b23bba337ce8b4
*/
'use strict';jsBoot.add(console).as("nativeConsole");jsBoot.pack("jsBoot.core",function(b){var a={debug:function(){},log:function(){},info:function(){},trace:function(){},warn:console.warn,error:console.error};this.toggleConsole=function(c){var f=c?b.nativeConsole:a;Object.getOwnPropertyNames(f).forEach(function(a){console[a]=f[a]})}});jsBoot.add(Error).as("NativeError");
jsBoot.pack("jsBoot.core",function(b){this.Error=function(a,c){var f=b.NativeError.apply(this,[c]);this!=window&&void 0!==this&&(this.message=f.message,this.stack=f.stack,this.name=a,this.stack||(this.stack="undefined"!=typeof printStackTrace?printStackTrace():[]))};Object.getOwnPropertyNames(b.NativeError.prototype).forEach(function(a){"constructor"!=a&&(this.Error.prototype[a]=b.NativeError.prototype[a])},this);"NOT_IMPLEMENTED UNSPECIFIED NOT_INITIALIZED WRONG_ARGUMENTS UNSUPPORTED NATURAL_BORN_CRASH".split(" ").forEach(function(a,
b){this.Error[a]=this.Error.prototype[a]=b},this);this.Error.prototype.toString=function(){return this.name+": "+this.message+"\nStack: "+("array"==typeof this.stack?this.stack.join("\n"):this.stack)}});
jsBoot.pack("jsBoot.core",function(){this.registerErrorHandler=function(a){b.push(a)};var b=[];window.onerror&&b.push(window.onerror);var a=function(a,b){console.error(" [jsBoot.core.errorHandler]",a,b)};window.onerror=function(c){var f=Array.prototype.slice.call(arguments);try{return b.some(function(a){return a.apply(null,f)})}catch(g){a("Some error handler shamefully failed to do anything useful because of",g),a('"Lost" error was:',c)}}});jsBoot.add(1).as("delay");
jsBoot.pack("jsBoot.types",function(b){this.EventDispatcher=function(){this.crash=!1;this.addEventListener=function(a,d,b,q){a in e||(e[a]=[],k[a]=[]);var c=d.bind(b);c.throwable=!!q;c.bound=d;c.context=b;e[a].push(c)};this.removeEventListener=function(a,d,b){a in e&&e[a].some(function(c,k){d==c.bound&&b==c.context&&e[a].splice(k,1)})};this.dispatchEvent=function(l,d,c){if(l in e||l==this.CHANGE&&(a in e||f in e))l in h&&clearTimeout(h[l]),l in k||(k[l]=[]),k[l].push(d),c?m(l):h[l]=setTimeout(m,b.delay,
l,this)};var e={},h={},k={};this.destroy=function(){Object.keys(h).forEach(function(a){clearTimeout(h[a])});k={};h={};e={}};var m=function(b,d){b in h&&delete h[b];b==c&&a in e&&(e[a]=g(e[a],d,a,{},"A before mutation event listener failed",this.crash));b in e&&k[b].forEach(function(a){e[b]=g(e[b],d,b,a,"An event listener failed",this.crash)},this);k[b].splice(0,k[b].length);b==c&&f in e&&(e[f]=g(e[f],d,f,{},"An after mutation event listener failed",this.crash))}.bind(this)};var a=this.EventDispatcher.prototype.BEFORE_MUTATION=
"changestart",c=this.EventDispatcher.prototype.CHANGE="change",f=this.EventDispatcher.prototype.AFTER_MUTATION="changestop",g=function(a,b,c,f,l,d){var n=!1,q={type:c,target:b,details:f},g=[];a=a.filter(function(a){if(d)n|=a(q);else try{n|=a(q)}catch(b){g.push(new jsBoot.core.Error("LISTENER_FAILURE",l+":"+b))}return!a.throwable});if(g.length)throw g.shift();return a}});jsBoot.use("jsBoot.types.EventDispatcher").as("dispatcher");
jsBoot.pack("jsBoot.types",function(b){this.Mutable=function(){if("undefined"!=typeof Ember){var a=new Ember.Object,c;for(c in a)"constructor"!=c&&"set"!=c&&(this[c]=a[c])}b.dispatcher.apply(this)};this.Mutable.prototype=Object.create(b.dispatcher.prototype);this.Mutable.prototype.set=this.Mutable.prototype.change=function(a,b){var f="undefined"!=typeof Ember?this.get(a):this[a];b!=f&&(this.dispatchEvent(this.CHANGE,{key:a,oldValue:f,newValue:b}),"undefined"!=typeof Ember?Ember.set(this,a,b):this[a]=
b)}});jsBoot.use("jsBoot.types.EventDispatcher");jsBoot.add(500).as("idleTime");jsBoot.add(5E3).as("staleTime");
jsBoot.pack("jsBoot.controllers",function(b){var a=function(){b.EventDispatcher.apply(this);var a,f=Date.now(),g="IDLE",e=!1;Object.defineProperty(this,"status",{get:function(){return g}});Object.defineProperty(this,"staled",{get:function(){return e}});var h=function(){"ACTIVE"==g?Date.now()-f>b.idleTime&&(g="IDLE",this.dispatchEvent("STATE_CHANGED")):!e&&Date.now()-f>b.staleTime&&(e=!0,this.dispatchEvent("STATE_CHANGED"))}.bind(this),k=function(){"BLURRED"!=g&&(f=Date.now(),"IDLE"==g&&(g="ACTIVE",
e=!1,this.dispatchEvent("STATE_CHANGED")))}.bind(this),m=function(){g="BLURRED";this.dispatchEvent("STATE_CHANGED")}.bind(this),l=function(){f=Date.now();g="ACTIVE";e=!1;this.dispatchEvent("STATE_CHANGED")}.bind(this);this.boot=function(d,n){d&&(b.idleTime=1E3*d);n&&(b.staleTime=1E3*n);document.addEventListener("mousemove",k,!0);document.addEventListener("click",k,!0);document.addEventListener("dblclick",k,!0);window.addEventListener("keypress",k,!0);window.addEventListener("blur",m,!0);window.addEventListener("focus",
l,!0);a=setInterval(h,b.idleTime/2)};this.shutdown=function(){this.destroy();clearInterval(a);document.removeEventListener("mousemove",k,!0);document.removeEventListener("click",k,!0);document.removeEventListener("dblclick",k,!0);window.removeEventListener("keypress",k,!0);window.removeEventListener("blur",m,!0);window.removeEventListener("focus",l,!0)}};a.prototype=Object.create(b.EventDispatcher.prototype,{STATE_CHANGED:{value:"STATE_CHANGED",writable:!1,enumerable:!0},ACTIVE:{value:"ACTIVE",writable:!1,
enumerable:!0},IDLE:{value:"IDLE",writable:!1,enumerable:!0},BLURRED:{value:"BLURRED",writable:!1,enumerable:!0}});this.userActivity=new a});jsBoot.add(window.localStorage).as("localStorage");jsBoot.add(window.sessionStorage).as("sessionStorage");jsBoot.add(1E3).as("lifeLength");jsBoot.use("jsBoot.types.EventDispatcher");jsBoot.use("jsBoot.core.Error");
jsBoot.pack("jsBoot.controllers",function(b){var a=function(a){return(b.localStorage.getItem("_jsbootsingleapp_"+a+"_lockname")||"").split("_")},c,f=!1,g=!1,e=function(d,c,k,e){var l=a(d);if(l.pop()!=c&&Date.now()-l.shift()<b.lifeLength){if(f||!g)f=!1,g=!0,e()}else f||(f=!0,g=!1,k()),c=Date.now()+"_"+c,b.localStorage.setItem("_jsbootsingleapp_"+d+"_lockname",c)},h=function(d,k){c&&(window.clearInterval(c),c=void 0);a(d).pop()==k&&b.localStorage.removeItem("_jsbootsingleapp_"+d+"_lockname");g=f=!1},
k,m=function(){k="acquired";this.dispatchEvent(this.STATE_CHANGED)},l=function(){k="waiting";this.dispatchEvent(this.STATE_CHANGED);throw new b.Error("ALREADY_LOCKED","Another instance of the app is already running.",!0);},d=function(){b.EventDispatcher.apply(this);Object.defineProperty(this,"status",{enumerable:!0,get:function(){return k}});var a,d;this.boot=function(f,g){g&&(b.lifeLength=1E3*g);k="waiting";var r=a=f,p;b.sessionStorage&&(p=b.sessionStorage.getItem("_jsbootsingleapp_"+r+"_instanceId"));
p||(p=Date.now()+"-"+Math.random(1E3),b.sessionStorage&&b.sessionStorage.setItem("_jsbootsingleapp_"+r+"_instanceId",p));d=p;h(a,d);r=m.bind(this);p=l.bind(this);c=window.setInterval(e,b.lifeLength/2,a,d,r,p)};this.shutdown=function(){this.destroy();h(a,d);a=d=null}};d.prototype=Object.create(b.EventDispatcher.prototype);d.prototype.ACQUIRED="acquired";d.prototype.WAITING="waiting";d.prototype.STATE_CHANGED="state_changed";this.singleApp=new d});
var IDB={indexedDB:window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,IDBTransaction:window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,IDBKeyRange:window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange};jsBoot.add(IDB).as("IDB");jsBoot.add(window.openDatabase,!0).as("openDatabase");jsBoot.add(window.localStorage,!0).as("localStorage");jsBoot.add(window.sessionStorage,!0).as("sessionStorage");jsBoot.add(window.JSON).as("json");jsBoot.use("jsBoot.core.Error");
jsBoot.pack("jsBoot.utils",function(b){var a;this.storage=new function(){this.persistent={};this.cache={};this.userCache={};this.userPersistent={};this.boot=function(a,b){e.init(a);h.init(a);var c=0,d=function(a,d){Object.keys(d).forEach(function(b){a[b]=d[b]});c++;1<c&&b&&b()};e.read(null,d.bind(this,this.persistent));h.read(null,d.bind(this,this.cache))};this.login=function(b,c){a=b;var l=0,d=function(a,b){Object.keys(b).forEach(function(d){a[d]=b[d]});l++;1<l&&c&&c()};e.read(a,d.bind({},this.userPersistent));
h.read(a,d.bind({},this.userCache))};this.logout=function(b){if(a){var c=0,l=function(a){Object.keys(a).forEach(function(b){delete a[b]});c++;1<c&&b&&b()};e.write(a,this.userPersistent,l.bind({},this.userPersistent));h.write(a,this.userCache,l.bind({},this.userCache));a=void 0}else setTimeout(b,1)};this.commit=function(){a&&(e.write(a,this.userPersistent),h.write(a,this.userCache));e.write(null,this.persistent);h.write(null,this.cache)};this.shutdown=function(a){this.logout(function(){var b=0,c=function(d){Object.keys(d).forEach(function(a){delete d[a]});
b++;1<b&&a&&a()};e.write(null,this.persistent,c.bind({},this.persistent));h.write(null,this.cache,c.bind({},this.cache))}.bind(this))}};var c=function(a,c){var e;return{init:function(a){console.info(" [ponyStorage] Using domStorage adapter",c);e=a},read:function(d,f){d=e+"_"+(d||"");var g,h;try{if(g=a.parse(c.getItem(d)||"{}"),!g)throw"whatever";}catch(s){c.removeItem(d),g={},h=new b.Error("DATA_CORRUPTION","Reading into the dataStore failed. This may be indicative of a possible data corruption.")}setTimeout(f,
1,g);if(h)throw h;},write:function(d,f,g){console.warn("jey writte!",d,f,g);d=e+"_"+(d||"");try{c.setItem(d,a.stringify(f)),g&&setTimeout(g,1,!0)}catch(h){throw c.removeItem(d),g&&setTimeout(g,1,!1),new b.Error("DATA_CORRUPTION","Writing into the dataStore failed. This may be indicative of a possible data corruption.");}}}},f=function(a,c){var e;return{init:function(a){console.info(" [ponyStorage] Using openDatabase adapter");e=c(a,"1.0.0",a,281474976710656);this.exec("create table if not exists main (id text(32,0) collate nocase unique primary key, data blob not null on conflict fail);",
[])},read:function(b,c){this.exec("select * from main where id=?;",["ns_"+(b||"")],function(b){c(b.length&&a.parse(b.item(0).data)||{})},function(){c({})})},write:function(b,c,e){b=b||"";c=a.stringify(c);this.exec("insert or replace into main (id, data) VALUES ( ?, ? );",["ns_"+b,c],e)},exec:function(a,c,f,g){e.transaction(function(e){e.executeSql(a,c||[],function(a,b){f&&f(b.rows)},function(e,f){console.error(" [ponyStorage] transaction failure",e,f,a,c);g&&g(f);throw new b.Error("DATA_CORRUPTION",
"Failed executing query");})})}}},g=function(){return{init:function(){console.warn(" [ponyStorage] Using bogus adapter!")},read:function(){return{}},write:function(){}}},e,h;e=b.openDatabase?f(b.json,b.openDatabase):b.localStorage?c(b.json,b.localStorage):g();b.sessionStorage?h=c(b.json,b.sessionStorage):b.localStorage?h=c(b.json,b.localStorage):e=g()});
jsBoot.pack("jsBoot.utils",function(){this.Tween=function(b,a,c,f,g,e){f=1E3*f/c;var h=0,k,m=Object.keys(a);m.forEach(function(b){a[b].range=a[b].end-a[b].start;a[b].unit=a[b].unit||""});var l=function(d){b[d]=a[d].start+g(a[d].range,h,c)+a[d].unit};k=setInterval(function(){h++;h>=c&&(clearInterval(k),e());m.forEach(l)},f)};this.Tween.EASE_IN=function(b,a,c){return Math.sqrt(a/c)*b};this.Tween.EASE_OUT=function(b,a,c){return Math.pow(a/c,2)*b};this.Tween.LINEAR=function(b,a,c){return a/c*b}});
