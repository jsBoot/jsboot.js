/*
 <a href="http://www.gnu.org/licenses/agpl-3.0.html">AGPL</a>.
 @copyright All rights reserved <a href="http://www.webitup.fr">copyright WebItUp</a>
 @name https://github.com/jsBoot/jsboot.js/blob/master/src/jsboot/controllers/singleapp.js#74-70c39446998be95596b03bc170b23bba337ce8b4
*/
'use strict';jsBoot.use("jsBoot.core.Error");jsBoot.pack("jsBoot.service",function(a){this.Error=function(f,c,d){a.Error.apply(this,arguments);this.details=d};this.Error.prototype=Object.create(a.Error.prototype);"OPENING_FAILED SEND_FAILED FAILED_UID MEANINGLESS_DATA BAD_REQUEST MISSING BAD_REQUEST UNAUTHORIZED INVALID_SIGNATURE WRONG_CREDENTIALS SHOULD_NOT_HAPPEN SERVICE_UNAVAILABLE UNSPECIFIED".split(" ").forEach(function(a){this[a]=this.prototype[a]=a},this.Error)});jsBoot.add(Mingus.xhr.XMLHttpRequest).as("XMLHttpRequest");
jsBoot.use("jsBoot.service.Error");
jsBoot.pack("jsBoot.service",function(a){this.SimpleClient=function(){};var f,c,d,k;this.SimpleClient.configure=function(a,b,e){this.host=f=a;this.port=c=b;this.version=d=e;k=null};Object.defineProperty(this.SimpleClient.prototype,"userId",{get:function(){return k},set:function(a){k=a}});Object.defineProperty(this.SimpleClient.prototype,"hostPort",{get:function(){return f+(c?":"+c:"")}});Object.defineProperty(this.SimpleClient.prototype,"version",{get:function(){return d}});this.SimpleClient.prototype.url=
function(a){var b="//"+f+(c?":"+c:"")+"/"+d;a.service&&(b+="/"+a.service);a.id&&(b+="/"+encodeURIComponent(a.id));a.command&&(b+="/"+a.command);a.additional&&(b+="/"+a.additional.map(encodeURIComponent).join("/"));a.params||(a.params={});var e=[];a.params&&Object.keys(a.params).forEach(function(b){e.push(encodeURIComponent(b)+"="+encodeURIComponent(a.params[b]))});e.length&&(b+="?"+e.join("&"));return b};var h=function(){var g=this.inner,b=this.onfailure,e=this.onsuccess,c=this.restart;if(g.readyState==
g.FAILED_OPENING)this.onsuccess=this.onfailure=this.inner=this.restart=g.onreadystatechange=null,this.error=new a.Error(a.Error.UNAUTHORIZED,"Not authorized to access this",this),b&&b(this.error);else if(g.readyState==g.DONE){this.onsuccess=this.onfailure=this.inner=this.restart=g.onreadystatechange=null;try{k=g.getResponseHeader("X-UID")||k}catch(d){throw this.exception=d,new a.Error(a.Error.FAILED_UID,"Cant read UID",this);}try{this.data={},g.responseText&&(this.data=JSON.parse(g.responseText))}catch(f){try{this.data=
(new DOMParser).parseFromString(g.responseText,"application/xml")}catch(h){this.error=new a.Error(a.Error.MEANINGLESS_DATA,"WHAT? ALBATROS?",this)}this.data.responseText=g.responseText}switch(g.status){case 200:case 201:break;case 308:this.id=null;this.params={};this.url=g.getResponseHeader("Location");c.engine.query(c.GET,this,c.headers);return;case 400:this.error=new a.Error(a.Error.BAD_REQUEST,"Bad request!",this);c={code:100,error:"GENERIC_ERROR"};try{c=JSON.parse(g.responseText)}catch(n){}this.data=
c;break;case 401:g.getResponseHeader("WWW-Authenticate")?this.error=new a.Error(a.Error.WRONG_CREDENTIALS,"Wrong street cred",this):this.error=new a.Error(a.Error.INVALID_SIGNATURE,"Invalid singing",this);break;case 402:case 403:case 405:case 501:this.error=new a.Error(a.Error.UNAUTHORIZED,"Not authorized to access this",this);break;case 404:this.error=new a.Error(a.Error.MISSING,"Missing resource",this);break;case 406:case 411:case 412:case 413:case 414:case 415:case 416:case 417:this.error=new a.Error(a.Error.SHOULD_NOT_HAPPEN,
"Should never happen",this);break;case 500:case 503:this.error=new a.Error(a.Error.SERVICE_UNAVAILABLE,"Server is down",this);break;case 0:this.error=new a.Error(a.Error.UNAUTHORIZED,"Not authorized to access this",this);break;default:this.error=new a.Error(a.Error.UNSPECIFIED,"WTF?",this)}e&&!this.error&&e(this.data);b&&this.error&&b(this.error,this.data,g)}};this.SimpleClient.prototype.query=function(c,b,e){c=c||this.GET;var d=b.url||this.url(b);e||(e={});e.Accept="application/json";e["X-IID"]=
"web";var f=new a.XMLHttpRequest;b.inner=f;b.error=null;b.data=null;f.onreadystatechange=h.bind(b);try{f.open(c,d,!0)}catch(k){throw b.exception=k.toString(),new a.Error(a.Error.OPENING_FAILED,"Failed opening likely bogus request",b);}d=b.payload;if(c==this.POST)if("undefined"!=typeof File&&"undefined"!=typeof Blob&&(d instanceof File||d instanceof Blob))e["Content-Type"]=d.type;else try{"Content-Type"in e&&"application/json"!=e["Content-Type"]||(d=JSON.stringify(d),e["Content-Type"]="application/json")}catch(l){"Content-Type"in
e||(e["Content-Type"]="image/jpeg")}Object.keys(e).forEach(function(a){f.setRequestHeader(a,e[a])});b.restart={engine:this,method:c,headers:e};try{f.send(d)}catch(n){throw b.exception=n,new a.Error(a.Error.SEND_FAILED,"Failed sending. Bogus payload?",b);}};this.SimpleClient.HEAD=this.SimpleClient.prototype.HEAD="HEAD";this.SimpleClient.GET=this.SimpleClient.prototype.GET="GET";this.SimpleClient.POST=this.SimpleClient.prototype.POST="POST";this.SimpleClient.PATCH=this.SimpleClient.prototype.PATCH=
"PATCH";this.SimpleClient.PUT=this.SimpleClient.prototype.PUT="PUT";this.SimpleClient.DELETE=this.SimpleClient.prototype.DELETE="DELETE"});jsBoot.add(Mingus.xhr.XMLHttpRequest).as("XMLHttpRequest");jsBoot.add(Mingus.xhr.digest).as("digest");jsBoot.add(Mingus.xhr.appKeyEngine).as("appKeyEngine");jsBoot.use("jsBoot.service.SimpleClient");jsBoot.use("jsBoot.service.Error");
jsBoot.pack("jsBoot.service",function(a){var f;this.core=new function(){this.requestor=new a.SimpleClient;this.initialize=function(c,d,k){f=k;k=["0","4","0"];a.XMLHttpRequest.gatePath="/"+d.version+"/connect/gate/"+k.shift()+"."+k.shift()+"/gate.html";a.SimpleClient.configure(d.host,d.port,d.version);a.appKeyEngine.setAppKey(d.host,c.id,c.secret);this.logout()};this.authenticate=function(c,d,k,h,g,b){this.requestor.userId=f.id;var e=a.digest.getEngine(this.requestor.hostPort);e.login=k.toLowerCase();
h?e.password=h:(e.ha1=g,e.realm=b);this.requestor.query(this.requestor.POST,{service:"users",onsuccess:c,onfailure:d,command:"authenticate",payload:{}})};this.logout=function(){this.requestor.userId=f.id;var c=a.digest.getEngine(this.requestor.hostPort);c.login=f.login;c.password=f.password;return!0};Object.defineProperty(this,"login",{get:function(){return a.digest.getEngine(this.requestor.hostPort).login}});Object.defineProperty(this,"id",{get:function(){return this.requestor.userId}})}});jsBoot.add(Mingus.xhr.digest).as("digest");
jsBoot.use("jsBoot.service.core");
jsBoot.pack("jsBoot.service",function(a){var f=a.core.requestor;this.account=new function(){this.create=function(a,d,k,h,g,b){f.query(f.POST,{service:"users",onsuccess:a,onfailure:d,command:"#",payload:{username:k,email:h.toLowerCase(),password:g,extra:b||{}}})};this.validate=function(a,d,k,h){f.query(f.POST,{service:"users",onsuccess:a,onfailure:d,command:"validate",payload:{code:h,email:k}})};this.activate=function(c,d){f.query(f.POST,{service:"users",onsuccess:c,onfailure:d,id:3==arguments.length?
arguments[2]:a.core.id,command:"activate"})};this.deactivate=function(c,d){f.query(f.POST,{service:"users",onsuccess:c,onfailure:d,id:3==arguments.length?arguments[2]:a.core.id,command:"deactivate"})};this.destroy=function(c,d){f.query(f.DELETE,{service:"users",onsuccess:c,onfailure:d,id:3==arguments.length?arguments[2]:a.core.id,command:""})}}});jsBoot.add(5E3).as("failureGrace");jsBoot.add(Mingus.xhr.digest).as("digest");jsBoot.use("jsBoot.core.Error");jsBoot.use("jsBoot.types.Mutable");jsBoot.use("jsBoot.service.core").as("service");
jsBoot.use("jsBoot.utils.storage");jsBoot.use("jsBoot.controllers.singleApp");jsBoot.use("jsBoot.controllers.userActivity");
jsBoot.pack("jsBoot.controllers",function(a){var f=function(){a.Mutable.apply(this);this.NOT_INITED="not";this.LOCKED_OUT="fail";this.USER_OUT="uout";this.SHUTDOWN="end";var c=this.INITIALIZED="inited",d=this.USER_READY="uready",f=this.USER_FAIL="ufail";this.status=this.NOT_INITED;Object.defineProperty(this,"userIdentifier",{configurable:!0,enumerable:!0,get:function(){return a.service.id}});var h={},g={},b={},e;this.delay=function(a,c){a in g||(g[a]=0,h[a]=0,b[a]=[]);b[a].push(c);g[a]++;h[a]++};
var p,s=function(b){if(e!=b)throw new a.Error("FAILURE_DELAYER","A very late delayer returned. Ignored.");h[b]--;h[b]||(window.clearTimeout(p),h[b]=g[b],e=null,this.set("status",b))},m=function(c){if(c in g&&h[c]){e=c;p&&window.clearTimeout(p);p=window.setTimeout(function(){h[c]=g[c];e=null;this.set("status",c);throw new a.Error("FAILURE_DELAYER","Something delayer you did failed. Bitch, please!");}.bind(this),a.failureGrace);var d=s.bind(this,c);b[c].forEach(function(a){a(d)})}else this.set("status",
c)}.bind(this),l={},n=!1,q=function(b,c,d){l.login=b;l.ha1=c;l.realm=d;a.storage.commit()},r=!0,t=function(){a.userActivity.addEventListener(a.userActivity.STATE_CHANGED,function(){a.userActivity.staled&&r&&(r=!1,a.storage.commit());a.userActivity.status==a.userActivity.ACTIVE&&(r=!0)})};this.boot=function(b,d){if(this.status!=this.NOT_INITED)throw new a.Error("ALREADY_BOOTED","You cant boot twice darling");a.singleApp.addEventListener(a.singleApp.STATE_CHANGED,function(){a.singleApp.status==a.singleApp.WAITING?
this.set("status",this.LOCKED_OUT):a.storage.boot(b,function(){"autologin"in a.storage.persistent||(a.storage.persistent.autologin={login:null,ha1:null,realm:null});l=a.storage.persistent.autologin;t();m(c)})},this);a.userActivity.boot();a.singleApp.boot(b);d&&a.service.initialize(d.key,d.server,d.anonymous)};this.login=function(b,c,e,g,h){if(this.status!=this.INITIALIZED)throw new a.Error("NOT_READY","You must init the app before you can login");n=e;a.service.authenticate(function(){if(n){var c=
a.digest.getEngine(a.service.requestor.hostPort);q(b,c.ha1,c.realm,e)}a.storage.login(a.service.id,function(){m(d)})},function(){m(f)},b,c,g,h)};this.logout=function(){m(this.USER_OUT)};this.shutdown=function(){this.status!=this.NOT_INITED&&m(this.SHUTDOWN)};this.addEventListener(this.AFTER_MUTATION,function(){switch(this.status){case this.INITIALIZED:l.login&&this.login(l.login,null,!0,l.ha1,l.realm);break;case this.USER_FAIL:q(null,null,null);this.set("status",this.INITIALIZED);break;case this.USER_OUT:q(null,
null,null);a.service.logout();a.storage.logout(function(){m(c)});break;case this.SHUTDOWN:a.storage.shutdown(function(){a.singleApp.shutdown();a.userActivity.shutdown()})}},this)};f.prototype=Object.create(a.Mutable.prototype);this.application=new f;window.onbeforeunload=function(){this.shutdown()}.bind(this.application)});
